/* DP - 03/22 - Reverted changes to 03/07 - Included extra space in the processed_flg='N '*/
MERGE INTO EDW.MDM.ITEM_DIM TGT USING 
(
select * from(  
WITH RN AS(
SELECT ISI_DC_CODE,
ISI_ITEM_CODE ,
ID,ROW_NUMBER() OVER(PARTITION BY LTRIM(ISI_DC_CODE,0),ISI_ITEM_CODE ORDER BY ISI_DATE_UPDATE DESC) AS RN
FROM EDW.FD.TDWH_NF_ITEM_HUB ) , 
  
 ITEMHS as (
SELECT
A.ISI_DC_CODE DIV_NBR,
CASE WHEN LEN(A.ISI_DC_CODE) IN (1) THEN SUBSTRING(A.ISI_ITEM_CODE,3,LEN(A.ISI_ITEM_CODE)) ELSE SUBSTRING(A.ISI_ITEM_CODE,LEN(A.ISI_DC_CODE)+1,LEN(A.ISI_ITEM_CODE)) END ITEM_NBR,
LEN(ITEM_NBR) AS ITEM_NBR_LEN,
SUBSTRING(ITEM_NBR,1,1) ITEM_NBR_1,
SUBSTRING(ITEM_NBR,2,1) ITEM_NBR_2,
SUBSTRING(ITEM_NBR,3,1) ITEM_NBR_3,
SUBSTRING(ITEM_NBR,4,1) ITEM_NBR_4,
SUBSTRING(ITEM_NBR,5,1) ITEM_NBR_5,
SUBSTRING(ITEM_NBR,6,1) ITEM_NBR_6,
CAST((ITEM_NBR_6||ITEM_NBR_4||ITEM_NBR_2) AS INT)*2 AS ITEM_CD_INT,
LPAD(ITEM_CD_INT,5,'0') AS ITEM_CD_INT_PAD,
SUBSTRING(ITEM_CD_INT_PAD,1,1) ITEM_CD_INT_PAD_1,
SUBSTRING(ITEM_CD_INT_PAD,2,1) ITEM_CD_INT_PAD_2,
SUBSTRING(ITEM_CD_INT_PAD,3,1) ITEM_CD_INT_PAD_3,
SUBSTRING(ITEM_CD_INT_PAD,4,1) ITEM_CD_INT_PAD_4,
SUBSTRING(ITEM_CD_INT_PAD,5,1) ITEM_CD_INT_PAD_5,
CAST(ITEM_CD_INT_PAD_1 AS INT)+CAST(ITEM_CD_INT_PAD_2 AS INT)+CAST(ITEM_CD_INT_PAD_3 AS INT)+CAST(ITEM_CD_INT_PAD_4 AS INT)+CAST(ITEM_CD_INT_PAD_5 AS INT) AS ITEM_CD_INT_ANS_1,
ITEM_CD_INT_ANS_1 + CAST(ITEM_NBR_1 AS INT)+CAST(ITEM_NBR_3 AS INT)+CAST(ITEM_NBR_5 AS INT) AS ITEM_CD_INT_ANS_2,
LPAD(ITEM_CD_INT_ANS_2,3,'0') AS ITEM_CD_INT_ANS_2_PAD,
SUBSTRING(ITEM_CD_INT_ANS_2_PAD,1,1) AS ITEM_CD_INT_ANS_2_PAD_1,
SUBSTRING(ITEM_CD_INT_ANS_2_PAD,2,1) AS ITEM_CD_INT_ANS_2_PAD_2,
SUBSTRING(ITEM_CD_INT_ANS_2_PAD,3,1) AS ITEM_CD_INT_ANS_2_PAD_3,
10-CAST(ITEM_CD_INT_ANS_2_PAD_3 AS INT) AS CHECK_DIGIT,
CASE WHEN CHECK_DIGIT>=10 THEN CAST(SUBSTRING(CHECK_DIGIT,2,1) AS INT) ELSE CAST(CHECK_DIGIT AS INT) END AS CK_DG,
CASE WHEN A.ISI_DC_CODE IN ('002','003','005','008','040','054','087') THEN LPAD(TRIM(ITEM_NBR||TRIM(CAST(CK_DG AS VARCHAR))),7,'0') 
     WHEN ITEM_NBR_LEN=6 THEN LPAD(ITEM_NBR,7,'0') 
     WHEN ITEM_NBR_LEN>6 THEN LPAD(ITEM_NBR,7,'0') END AS ITEM_NBR_HS
FROM "EDW"."FD"."TDWH_NF_ITEM_HUB" A)
  
  
,NW_INS as 
(SELECT 
(select max(ITEM_PK) from EDW.MDM.ITEM_DIM  )+ row_number() over(order by null) ITEM_PK, 
CASE WHEN T2.TPARLIBC='IN' THEN ((A.ARTUL_PACK_ARULONG*A.ARTUL_PACK_ARULARG*A.ARTUL_PACK_ARUHAUT)/1728)
     WHEN T2.TPARLIBC='FT' THEN (A.ARTUL_PACK_ARULONG*A.ARTUL_PACK_ARULARG*A.ARTUL_PACK_ARUHAUT*1728)
     WHEN T2.TPARLIBC='YD' THEN (A.ARTUL_PACK_ARULONG*A.ARTUL_PACK_ARULARG*A.ARTUL_PACK_ARUHAUT*27)
     WHEN T2.TPARLIBC='MM' THEN ((A.ARTUL_PACK_ARULONG*A.ARTUL_PACK_ARULARG*A.ARTUL_PACK_ARUHAUT)/28317)
     ELSE (A.ARTUL_PACK_ARULONG*A.ARTUL_PACK_ARULARG*A.ARTUL_PACK_ARUHAUT*1) END MASTER_CASE_CUBE,
CASE WHEN T1.TPARLIBC='IN' THEN ((A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARUHAUT)/1728)
     WHEN T1.TPARLIBC='FT' THEN (A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARUHAUT*1728)
     WHEN T1.TPARLIBC='YD' THEN (A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARUHAUT*27)
     WHEN T1.TPARLIBC='MM' THEN ((A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARUHAUT)/28317)
     ELSE (A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARULARG*A.ARTUL_SPCK_ARUHAUT*1) END SHIPPING_CASE_CUBE,
to_varchar(A.ARTUC_ARACALC) AS 	MILT_ITEM_TYPE,
A.ARTRAC_ARTQUAL AS PRIVATE_LABEL_KEY,
A.ISI_AWP_AMT  AS   AVG_WHOLESALE_PRICE,
A.ISI_COOL_ID AS COOL_PRIMARY,
A.ISI_COOL AS COOL_COUNTRY_CODE,
B.ARTCOUL_UPC_ACUCODE AS upc_unit,
B.ARTCOCA_UPC_ARCCODE AS UPC_CASE,
A.ARTUV_ARVPUVC as RET_UNIT_SIZE,
case when LEN(T.TPARLIBC)=2 THEN T.TPARLIBC WHEN LEN(T.TPARLIBC)>2 AND UPPER(T.TPARLIBC)='GALLON' THEN 'GL' WHEN LEN(T.TPARLIBC)>2 AND UPPER(T.TPARLIBC)='INCH' THEN 'IN' WHEN LEN(T.TPARLIBC)>2 AND UPPER(T.TPARLIBC)='GRAMS' THEN 'GR'
ELSE '' END RET_UNIT_DESC,
A.ISI_DC_CODE AS 	FACILITY_PK,
I.ITEM_NBR_HS ITEM_NBR_HS,
A.ISI_WHOLESALE_SIZE AS 	ITEM_SIZE,
A.ISI_WHOLESALE_UOM AS 	ITEM_SIZE_UOM,
A.ARTCOUL_GTIN_ACUCODE AS 	GTIN_NBR,
A.ARTUL_UNIT_ARULONG AS 	SKU_CASE_LENGTH,
A.ARTUL_UNIT_ARULARG AS 	SKU_CASE_WIDTH,
A.ARTUL_UNIT_ARUHAUT AS 	SKU_CASE_HEIGHT,
A.ISI_STRAIGHT_PACK AS 	STRAIGHT_PACK,
A.ISI_REASON AS 	NEW_ITEM_REASON_CD,
cast(I.ITEM_NBR_HS AS INT) ITEM_NBR,
A.ISI_GPC_MDSE_CLS_CODE AS 	MDSE_CLASS_KEY,
A.ISI_ITEM_DESC AS 	ITEM_DESCRIP,
A.ISI_SIZE_UNIT AS 	ITEM_SIZE_DESCRIP,

A.ISI_POS_DESC AS 	SHORT_DESCRIPTION,
A.ARTUL_PACK_ARUCINL AS 	MASTER_PACK,
A.ARTUL_UNIT_ARUCINL AS 	RETAIL_PACK,
A.ARTUL_PACK_ARULONG AS 	MASTER_CASE_LENGTH,
A.ARTUL_PACK_ARULARG AS 	MASTER_CASE_WIDTH,
A.ARTUL_PACK_ARUHAUT AS 	MASTER_CASE_HEIGHT,
A.ARTUL_PACK_ARUPBRU AS 	MASTER_CASE_WEIGTH,
A.ARTUL_SPCK_ARULONG AS 	SHIPPING_CASE_LENGTH,
A.ARTUL_SPCK_ARULARG AS 	SHIPPING_CASE_WIDTH,
A.ARTUL_SPCK_ARUHAUT AS 	SHIPPING_CASE_HEIGHT,
A.ARTUL_SPCK_ARUPBRU AS 	SHIPPING_CASE_WEIGHT,
A.ARTULUL_PALLET_ALLCOEFF AS 	VENDOR_TIER,
 A.ARTULUL_SPCK_ALLCOEFF AS STORE_PACK_CASE,
A.ISI_REASON AS 	NEW_ITEM_REASON_CODE,
A.ISI_REPLACE_ITEM AS 	REPLACE_ITEM_NBR,
A.ISI_SHIPPER_TYPE AS 	SHIPPER_FLAG,
B.ARTRAC_ARTDLIM AS 	SHELF_LIFE,
A.ISI_BRAND AS 	BRAND,
A.ISI_LV_DESCRIPTION AS 	LV_DESC,
A.ISI_ROOT_ITEM_DESC AS 	ROOT_DESC,
A.ARTUV_ARVCEXV AS 	ROOT_ITEM_NBR,
A.ARTUV_ARVCEXV AS 	LV_ITEM_NBR,
A.ARTUL_UNIT_ARUTYPUL AS 	LU_TYPE,
A.ARTUC_ARACEAN AS 	COPY_FROM_ITEM_NBR,
A.ISI_CPR_SRP AS 	ISI_CPR_SRP,
A.ISI_CPR_EXT AS 	ISI_CPR_EXT,
A.ISI_CREATED_BY AS 	ISI_CREATED_BY,
A.ISI_FIRST_SHIP_DATE AS 	ISI_FIRST_SHIP_DATE,
A.ISI_MSA_CODE AS 	MSA_CAT_CODE,
A.ISI_STICK_COUNT AS 	MSA_STICK_COUNT,
A.ISI_INNERPACK_SU AS 	ISI_INNERPACK_SU,
A.ISI_INNERPACK_COEF AS 	ISI_INNERPACK_COEF,
A.ISI_INNERPACK_DESC AS 	ISI_INNERPACK_DESC,
A.ISI_INNERPACK_SIZE AS 	ISI_INNERPACK_SIZE,
A.ISI_INNERPACK_UOM AS 	ISI_INNERPACK_UOM,
A.ISI_INNERPACK_UPC AS 	ISI_INNERPACK_UPC,
A.ISI_ITEM_BRAND_CD AS 	BRAND_CD,
A.ISI_RETAIL_ITEM_DESC AS 	RETAIL_ITEM_DESC,
A.ISI_POS_16_DESC AS 	POS_16_DESC,
A.ARTRAC_ARTCOLL AS 	BRAND_KEY,
B.ISI_CODE_DATE_FLG AS 	CODE_DATE_FLAG, 
B.ISI_CODE_DATE_MIN AS 	CODE_DATE_MIN,
B.ISI_CODE_DATE_MAX AS 	CODE_DATE_MAX,
A.ARTUL_PACK_ARUPGER AS 	NET_WEIGHT,
A.ISI_DO_NOT_SHOW_ON_INSITE AS 	INSITE_FLG,
CASE WHEN MOD(((CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),1,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),3,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),5,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),7,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),9,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),11,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),13,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),15,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),17,1) AS INT))*3)
+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),2,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),4,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),6,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),8,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),10,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),12,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),14,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),16,1) AS INT),10)=0
THEN SUBSTRING(lpad(A.ISI_INNERPACK_UPC,17,'0'),2,16)||'0'
ELSE SUBSTRING(lpad(A.ISI_INNERPACK_UPC,17,'0'),2,16)||
CAST(CAST(MOD(((CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),1,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),3,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),5,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),7,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),9,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),11,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),13,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),15,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),17,1) AS INT))*3)
+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),2,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),4,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),6,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),8,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),10,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),12,1) AS INT)+
CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),14,1) AS INT)+CAST(substring(lpad(A.ISI_INNERPACK_UPC,17,'0'),16,1) AS INT),10) AS INT) AS VARCHAR)
END ISI_INNERPACK_UPC_CD,
A.ARTUV_ARVCEXV AS 	SV_ITEM_NBR,
A.ISI_POS_DESC AS 	SV_DESC,
C.ARLTYPVL AS 	LV_ITEM_TYPE,
CURRENT_TIMESTAMP AS 	CREATE_TMSP,
case when DATE(FD)='1780-01-01' then '1900-01-01' else DATE(FD) end AS 	START_DT,
DATE(TD) AS 	END_DT,
NULL  AS LAST_UPDT_TMSP,
CASE WHEN DATE(TD)='9999-12-31' THEN 1 ELSE 0 END AS CURRENT_FLG,
'MDM' AS ORIGIN,
A.RUNNO_INSERT,A.RUNNO_UPDATE,B.RUNNO_INSERT,B.RUNNO_UPDATE

FROM EDW.FD.TDWH_NF_ITEM_HUB A
INNER JOIN EDW.FD.TDWH_NF_ITEM_S01 B ON A.ID=B.ID
INNER JOIN ITEMHS I ON I.DIV_NBR=A.ISI_DC_CODE AND i.item_nbr=CASE WHEN LEN(A.ISI_DC_CODE) IN (1) THEN SUBSTRING(A.ISI_ITEM_CODE,3,LEN(A.ISI_ITEM_CODE)) ELSE SUBSTRING(A.ISI_ITEM_CODE,LEN(A.ISI_DC_CODE)+1,LEN(A.ISI_ITEM_CODE)) END
INNER JOIN EDW.MDM.FACILITY_DIM  D ON A.ISI_DC_CODE=D.FACILITY_NBR AND D.ACTIVE_FLAG='Y' 
INNER JOIN EDW.FD.TDWH_TRA_PARPOSTES_HUB T ON T.TPARTABL=806 AND T.LANGUE='NF' AND T.TPARCMAG=0 AND A.ARTUV_ARVUUVC=T.TPARPOST
INNER JOIN RN CC ON CC.ISI_DC_CODE=A.ISI_DC_CODE  and CC.ISI_ITEM_CODE=A.ISI_ITEM_CODE  AND CC.RN=1
INNER JOIN (SELECT TPARPOST,TPARLIBC,TPARLIBL FROM EDW.FD.TDWH_TRA_PARPOSTES_HUB WHERE TPARTABL=806 AND LANGUE='NF' AND TPARCMAG=0) T1 ON (A.ARTUL_SPCK_ARUUMES=T1.TPARPOST)
INNER JOIN (SELECT TPARPOST,TPARLIBC,TPARLIBL FROM EDW.FD.TDWH_TRA_PARPOSTES_HUB WHERE TPARTABL=806 AND LANGUE='NF' AND TPARCMAG=0) T2 ON (A.ARTUL_PACK_ARUUMES=T2.TPARPOST)
LEFT JOIN EDW.FD.TDWH_ARTVL_COMP_HUB  C ON A.ARTVL_ARLSEQVL=C.ARLSEQVL 
  WHERE  
   A.RUNNO_INSERT>= (SELECT MIN(LAST_RUN_NBR) FROM EDW.AUDIT.CONTROL_RUN_STATUS
                                         WHERE TARGET_TABLENAME='TDWH_NF_ITEM_HUB' AND PROCESSED_FLG='N ')
  OR
   A.RUNNO_UPDATE>=(SELECT MIN(LAST_RUN_NBR) FROM EDW.AUDIT.CONTROL_RUN_STATUS
                                         WHERE TARGET_TABLENAME='TDWH_NF_ITEM_HUB' AND PROCESSED_FLG='N ')
  OR
  B.RUNNO_INSERT>=(SELECT MIN(LAST_RUN_NBR) FROM EDW.AUDIT.CONTROL_RUN_STATUS
                                         WHERE TARGET_TABLENAME='TDWH_NF_ITEM_S01' AND PROCESSED_FLG='N ')
  OR
   B.RUNNO_UPDATE>=(SELECT MIN(LAST_RUN_NBR) FROM EDW.AUDIT.CONTROL_RUN_STATUS
                                         WHERE TARGET_TABLENAME='TDWH_NF_ITEM_S01' AND PROCESSED_FLG='N ')
)

SELECT 
N.ITEM_PK,
N.MASTER_CASE_CUBE,
N.SHIPPING_CASE_CUBE,
N.MILT_ITEM_TYPE,
N.PRIVATE_LABEL_KEY,
N.AVG_WHOLESALE_PRICE,
N.COOL_PRIMARY,
N.COOL_COUNTRY_CODE,
N.upc_unit,
N.UPC_CASE,
N.RET_UNIT_SIZE,
N.RET_UNIT_DESC,
N.FACILITY_PK,
N.ITEM_NBR_HS,
N.ITEM_SIZE,
N.ITEM_SIZE_UOM,
N.GTIN_NBR,
N.SKU_CASE_LENGTH,
N.SKU_CASE_WIDTH,
N.SKU_CASE_HEIGHT,
N.STRAIGHT_PACK,
N.NEW_ITEM_REASON_CD,
N.ITEM_NBR,
N.MDSE_CLASS_KEY,
N.ITEM_DESCRIP,
N.ITEM_SIZE_DESCRIP,
N.SHORT_DESCRIPTION,
N.MASTER_PACK,
N.RETAIL_PACK,
N.MASTER_CASE_LENGTH,
N.MASTER_CASE_WIDTH,
N.MASTER_CASE_HEIGHT,
N.MASTER_CASE_WEIGTH,
N.SHIPPING_CASE_LENGTH,
N.SHIPPING_CASE_WIDTH,
N.SHIPPING_CASE_HEIGHT,
N.SHIPPING_CASE_WEIGHT,
N.VENDOR_TIER,
N.STORE_PACK_CASE,
N.NEW_ITEM_REASON_CODE,
N.REPLACE_ITEM_NBR,
N.SHIPPER_FLAG,
N.SHELF_LIFE,
N.BRAND,
N.LV_DESC,
N.ROOT_DESC,
N.ROOT_ITEM_NBR,
N.LV_ITEM_NBR,
N.LU_TYPE,
N.COPY_FROM_ITEM_NBR,
N.ISI_CPR_SRP,
N.ISI_CPR_EXT,
N.ISI_CREATED_BY,
N.ISI_FIRST_SHIP_DATE,
N.MSA_CAT_CODE,
N.MSA_STICK_COUNT,
N.ISI_INNERPACK_SU,
N.ISI_INNERPACK_COEF,
N.ISI_INNERPACK_DESC,
N.ISI_INNERPACK_SIZE,
N.ISI_INNERPACK_UOM,
N.ISI_INNERPACK_UPC,
N.BRAND_CD,
N.RETAIL_ITEM_DESC,
N.POS_16_DESC,
N.BRAND_KEY,
N.CODE_DATE_FLAG,
N.CODE_DATE_MIN,
N.CODE_DATE_MAX,
N.NET_WEIGHT,
N.INSITE_FLG,
N.ISI_INNERPACK_UPC_CD,
N.SV_ITEM_NBR,
N.SV_DESC,
N.LV_ITEM_TYPE,
N.CREATE_TMSP,
N.START_DT,
N.END_DT,
N.LAST_UPDT_TMSP,
N.CURRENT_FLG,
N.ORIGIN,
'SRC'  SRC_TYPE FROM NW_INS N

UNION

SELECT DIM.ITEM_PK,
DIM.MASTER_CASE_CUBE,
DIM.SHIPPING_CASE_CUBE,
DIM.MILT_ITEM_TYPE,
DIM.PRIVATE_LABEL_KEY,
DIM.AVG_WHOLESALE_PRICE,
DIM.COOL_PRIMARY,
DIM.COOL_COUNTRY_CODE,
DIM.upc_unit,
DIM.UPC_CASE,
DIM.RET_UNIT_SIZE,
DIM.RET_UNIT_DESC,
DIM.FACILITY_ID,
DIM.ITEM_NBR_HS,
DIM.ITEM_SIZE,
DIM.ITEM_SIZE_UOM,
DIM.GTIN_NBR,
DIM.SKU_CASE_LENGTH,
DIM.SKU_CASE_WIDTH,
DIM.SKU_CASE_HEIGHT,
DIM.STRAIGHT_PACK,
DIM.NEW_ITEM_REASON_CD,
DIM.ITEM_NBR,
DIM.MDSE_CLASS_KEY,
DIM.ITEM_DESCRIP,
DIM.ITEM_SIZE_DESCRIP,
DIM.SHORT_DESCRIPTION,
DIM.MASTER_PACK,
DIM.RETAIL_PACK,
DIM.MASTER_CASE_LENGTH,
DIM.MASTER_CASE_WIDTH,
DIM.MASTER_CASE_HEIGHT,
DIM.MASTER_CASE_WEIGTH,
DIM.SHIPPING_CASE_LENGTH,
DIM.SHIPPING_CASE_WIDTH,
DIM.SHIPPING_CASE_HEIGHT,
DIM.SHIPPING_CASE_WEIGHT,
DIM.VENDOR_TIER,
DIM.STORE_PACK_CASE,
DIM.NEW_ITEM_REASON_CODE,
DIM.REPLACE_ITEM_NBR,
DIM.SHIPPER_FLAG,
DIM.SHELF_LIFE,
DIM.BRAND,
DIM.LV_DESC,
DIM.ROOT_DESC,
DIM.ROOT_ITEM_NBR,
DIM.LV_ITEM_NBR,
DIM.LU_TYPE,
DIM.COPY_FROM_ITEM_NBR,
DIM.ISI_CPR_SRP,
DIM.ISI_CPR_EXT,
DIM.ISI_CREATED_BY,
DIM.ISI_FIRST_SHIP_DATE,
DIM.MSA_CAT_CODE,
DIM.MSA_STICK_COUNT,
DIM.ISI_INNERPACK_SU,
DIM.ISI_INNERPACK_COEF,
DIM.ISI_INNERPACK_DESC,
DIM.ISI_INNERPACK_SIZE,
DIM.ISI_INNERPACK_UOM,
DIM.ISI_INNERPACK_UPC,
DIM.BRAND_CD,
DIM.RETAIL_ITEM_DESC,
DIM.POS_16_DESC,
DIM.BRAND_KEY,
DIM.CODE_DATE_FLAG,
DIM.CODE_DATE_MIN,
DIM.CODE_DATE_MAX,
DIM.NET_WEIGHT,
DIM.INSITE_FLG,
DIM.ISI_INNERPACK_UPC_CD,
DIM.SV_ITEM_NBR,
DIM.SV_DESC,
DIM.LV_ITEM_TYPE,
DIM.CREATE_TMSP,
NW_INS.START_DT,
DIM.END_DT,
DIM.UPDATE_TMSP,
DIM.CURRENT_FLG,
DIM.ORIGIN,
'TGT'  SRC_TYPE
FROM EDW.MDM.ITEM_DIM   DIM
	INNER JOIN (SELECT FACILITY_PK,ITEM_NBR, RANK() over (partition by  NW_INS.FACILITY_PK, NW_INS.ITEM_NBR 
order by NW_INS.START_DT) as rnk, NW_INS.START_DT FROM NW_INS) NW_INS ON  NW_INS.FACILITY_PK = DIM.FACILITY_ID
AND  NW_INS.ITEM_NBR = DIM.ITEM_NBR  AND CURRENT_FLG=1 AND NW_INS.rnk=1
)  )SRC

ON SRC.ITEM_NBR=TGT.ITEM_NBR and SRC.FACILITY_PK=TGT.FACILITY_ID AND src.SRC_TYPE='TGT'
WHEN MATCHED AND TGT.CURRENT_FLG=1  THEN
UPDATE SET TGT.END_DT=dateadd(d,-1,src.START_DT), TGT.CURRENT_FLG=0, 
tgt.UPDATE_TMSP=TO_TIMESTAMP_LTZ(CURRENT_TIMESTAMP)  
WHEN NOT MATCHED THEN

INSERT (
TGT.MASTER_CASE_CUBE,
TGT.SHIPPING_CASE_CUBE,
TGT.MILT_ITEM_TYPE,
TGT.PRIVATE_LABEL_KEY,
TGT.AVG_WHOLESALE_PRICE,
TGT.COOL_PRIMARY,
TGT.COOL_COUNTRY_CODE,
TGT.upc_unit,
TGT.UPC_CASE,
TGT.RET_UNIT_SIZE,
TGT.RET_UNIT_DESC,
TGT.ITEM_PK,
TGT.FACILITY_ID,
TGT.ITEM_NBR_HS,
TGT.ITEM_SIZE,
TGT.ITEM_SIZE_UOM,
TGT.GTIN_NBR,
TGT.SKU_CASE_LENGTH,
TGT.SKU_CASE_WIDTH,
TGT.SKU_CASE_HEIGHT,
TGT.STRAIGHT_PACK,
TGT.NEW_ITEM_REASON_CD,
TGT.ITEM_NBR,
TGT.MDSE_CLASS_KEY,
TGT.ITEM_DESCRIP,
TGT.ITEM_SIZE_DESCRIP,
--TGT.ITEM_ADDED_DATE,
TGT.SHORT_DESCRIPTION,
TGT.MASTER_PACK,
TGT.RETAIL_PACK,
TGT.MASTER_CASE_LENGTH,
TGT.MASTER_CASE_WIDTH,
TGT.MASTER_CASE_HEIGHT,
TGT.MASTER_CASE_WEIGTH,
TGT.SHIPPING_CASE_LENGTH,
TGT.SHIPPING_CASE_WIDTH,
TGT.SHIPPING_CASE_HEIGHT,
TGT.SHIPPING_CASE_WEIGHT,
TGT.VENDOR_TIER,
TGT.STORE_PACK_CASE,
TGT.NEW_ITEM_REASON_CODE,
TGT.REPLACE_ITEM_NBR,
TGT.SHIPPER_FLAG,
TGT.SHELF_LIFE,
TGT.BRAND,
TGT.LV_DESC,
TGT.ROOT_DESC,
TGT.ROOT_ITEM_NBR,
TGT.LV_ITEM_NBR,
TGT.LU_TYPE,
TGT.COPY_FROM_ITEM_NBR,
TGT.ISI_CPR_SRP,
TGT.ISI_CPR_EXT,
TGT.ISI_CREATED_BY,
TGT.ISI_FIRST_SHIP_DATE,
TGT.MSA_CAT_CODE,
TGT.MSA_STICK_COUNT,
TGT.ISI_INNERPACK_SU,
TGT.ISI_INNERPACK_COEF,
TGT.ISI_INNERPACK_DESC,
TGT.ISI_INNERPACK_SIZE,
TGT.ISI_INNERPACK_UOM,
TGT.ISI_INNERPACK_UPC,
TGT.BRAND_CD,
TGT.RETAIL_ITEM_DESC,
TGT.POS_16_DESC,
TGT.BRAND_KEY,
TGT.CODE_DATE_FLAG,
TGT.CODE_DATE_MIN,
TGT.CODE_DATE_MAX,
TGT.NET_WEIGHT,
TGT.INSITE_FLG,
TGT.ISI_INNERPACK_UPC_CD,
TGT.SV_ITEM_NBR,
TGT.SV_DESC,
TGT.LV_ITEM_TYPE,
TGT.CREATE_TMSP,
TGT.START_DT,
TGT.END_DT,
TGT.UPDATE_TMSP,
TGT.CURRENT_FLG,
TGT.ORIGIN,
TGT.ITEM_NBR_NUM,
TGT.ITEM_NBR_HS_NUM,
TGT.REPLACE_ITEM_NBR_NUM,
TGT.COPY_FROM_ITEM_NBR_NUM)
 VALUES (
SRC.MASTER_CASE_CUBE,
SRC.SHIPPING_CASE_CUBE,
SRC.MILT_ITEM_TYPE,
SRC.PRIVATE_LABEL_KEY,
SRC.AVG_WHOLESALE_PRICE,
SRC.COOL_PRIMARY,
SRC.COOL_COUNTRY_CODE,
SRC.upc_unit,
SRC.UPC_CASE,
SRC.RET_UNIT_SIZE,
SRC.RET_UNIT_DESC,
SRC.ITEM_PK,
SRC.FACILITY_PK,
SRC.ITEM_NBR_HS,
SRC.ITEM_SIZE,
SRC.ITEM_SIZE_UOM,
SRC.GTIN_NBR,
SRC.SKU_CASE_LENGTH,
SRC.SKU_CASE_WIDTH,
SRC.SKU_CASE_HEIGHT,
SRC.STRAIGHT_PACK,
SRC.NEW_ITEM_REASON_CD,
SRC.ITEM_NBR,
SRC.MDSE_CLASS_KEY,
SRC.ITEM_DESCRIP,
SRC.ITEM_SIZE_DESCRIP,
--SRC.ITEM_ADDED_DATE,
SRC.SHORT_DESCRIPTION,
SRC.MASTER_PACK,
SRC.RETAIL_PACK,
SRC.MASTER_CASE_LENGTH,
SRC.MASTER_CASE_WIDTH,
SRC.MASTER_CASE_HEIGHT,
SRC.MASTER_CASE_WEIGTH,
SRC.SHIPPING_CASE_LENGTH,
SRC.SHIPPING_CASE_WIDTH,
SRC.SHIPPING_CASE_HEIGHT,
SRC.SHIPPING_CASE_WEIGHT,
SRC.VENDOR_TIER,
SRC.STORE_PACK_CASE,
SRC.NEW_ITEM_REASON_CODE,
SRC.REPLACE_ITEM_NBR,
SRC.SHIPPER_FLAG,
SRC.SHELF_LIFE,
SRC.BRAND,
SRC.LV_DESC,
SRC.ROOT_DESC,
SRC.ROOT_ITEM_NBR,
SRC.LV_ITEM_NBR,
SRC.LU_TYPE,
SRC.COPY_FROM_ITEM_NBR,
SRC.ISI_CPR_SRP,
SRC.ISI_CPR_EXT,
SRC.ISI_CREATED_BY,
SRC.ISI_FIRST_SHIP_DATE,
SRC.MSA_CAT_CODE,
SRC.MSA_STICK_COUNT,
SRC.ISI_INNERPACK_SU,
SRC.ISI_INNERPACK_COEF,
SRC.ISI_INNERPACK_DESC,
SRC.ISI_INNERPACK_SIZE,
SRC.ISI_INNERPACK_UOM,
SRC.ISI_INNERPACK_UPC,
SRC.BRAND_CD,
SRC.RETAIL_ITEM_DESC,
SRC.POS_16_DESC,
SRC.BRAND_KEY,
SRC.CODE_DATE_FLAG,
SRC.CODE_DATE_MIN,
SRC.CODE_DATE_MAX,
SRC.NET_WEIGHT,
SRC.INSITE_FLG,
SRC.ISI_INNERPACK_UPC_CD,
SRC.SV_ITEM_NBR,
SRC.SV_DESC,
SRC.LV_ITEM_TYPE,
SRC.CREATE_TMSP,
SRC.START_DT,
CASE WHEN SRC.END_DT<>'9999-12-31' THEN DATEADD(D,-1,SRC.END_DT) ELSE SRC.END_DT END,
CASE WHEN SRC.END_DT='9999-12-31'THEN NULL ELSE CURRENT_TIMESTAMP END,
CASE WHEN SRC.END_DT='9999-12-31' THEN 1 ELSE 0 END,
SRC.ORIGIN,
TRY_TO_NUMBER(REGEXP_REPLACE(SRC.ITEM_NBR,'\\D')),
TRY_TO_NUMBER(REGEXP_REPLACE(SRC.ITEM_NBR_HS,'\\D')),
TRY_TO_NUMBER(REGEXP_REPLACE(SRC.REPLACE_ITEM_NBR,'\\D')),
TRY_TO_NUMBER(REGEXP_REPLACE(SRC.COPY_FROM_ITEM_NBR,'\\D'))
);